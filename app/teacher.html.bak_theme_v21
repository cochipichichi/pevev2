<!doctype html>
<html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Profesor â€” PEVE</title>
<link rel="stylesheet" href="../assets/style.css">
<script defer src="../assets/app.js">
let chartCourse, chartStudent;
function renderCourseChart(rows){
  const ctx = document.getElementById('chart-course').getContext('2d');
  const labels = rows.map(r=>r.oa);
  const dataAvg = rows.map(r=>Number(r.promedio));
  const dataAtt = rows.map(r=>Number(r.intentos));
  if(chartCourse) chartCourse.destroy();
  chartCourse = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg},
        {label:'Intentos', data: dataAtt}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}
function renderStudentChart(rows){
  const ctx = document.getElementById('chart-student').getContext('2d');
  const labels = rows.map(r=>`${r.courseId}-${r.oa}`);
  const dataAvg = rows.map(r=>Number(r.promedio));
  if(chartStudent) chartStudent.destroy();
  chartStudent = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}

async function loadStatsCourse(){
  const id = $('#st_course').value.trim();
  if(!id) return alert('Ingresa courseId');
  const r = await PEVE_ADMIN.peveStatsByCourse(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-course tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderCourseChart(r.rows||[]);
}

async function loadStatsStudent(){
  const id = $('#st_user').value.trim();
  if(!id) return alert('Ingresa userId');
  const r = await PEVE_ADMIN.peveStatsByStudent(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-student tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.courseId}</td><td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderStudentChart(r.rows||[]);
}
</script>

<script>
window.addEventListener('DOMContentLoaded', async()=>{
  const u = getSession(); if(!u || u.role!=='teacher') return location.href='login.html';
  $('#who').textContent = u.name;
  const course = await fetch('../data/courses.json').then(r=>r.json()).then(j=>j["BiologÃ­a 1M"]);
  const oaList = $('#oa');
  course.oas.forEach(oa=>{ const li = document.createElement('li'); li.textContent = oa.code+" â€” "+oa.name; oaList.appendChild(li); });
});

let chartCourse, chartStudent;
function renderCourseChart(rows){
  const ctx = document.getElementById('chart-course').getContext('2d');
  const labels = rows.map(r=>r.oa);
  const dataAvg = rows.map(r=>Number(r.promedio));
  const dataAtt = rows.map(r=>Number(r.intentos));
  if(chartCourse) chartCourse.destroy();
  chartCourse = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg},
        {label:'Intentos', data: dataAtt}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}
function renderStudentChart(rows){
  const ctx = document.getElementById('chart-student').getContext('2d');
  const labels = rows.map(r=>`${r.courseId}-${r.oa}`);
  const dataAvg = rows.map(r=>Number(r.promedio));
  if(chartStudent) chartStudent.destroy();
  chartStudent = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}

async function loadStatsCourse(){
  const id = $('#st_course').value.trim();
  if(!id) return alert('Ingresa courseId');
  const r = await PEVE_ADMIN.peveStatsByCourse(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-course tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderCourseChart(r.rows||[]);
}

async function loadStatsStudent(){
  const id = $('#st_user').value.trim();
  if(!id) return alert('Ingresa userId');
  const r = await PEVE_ADMIN.peveStatsByStudent(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-student tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.courseId}</td><td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderStudentChart(r.rows||[]);
}
</script>

<script defer src="../assets/api.js">
let chartCourse, chartStudent;
function renderCourseChart(rows){
  const ctx = document.getElementById('chart-course').getContext('2d');
  const labels = rows.map(r=>r.oa);
  const dataAvg = rows.map(r=>Number(r.promedio));
  const dataAtt = rows.map(r=>Number(r.intentos));
  if(chartCourse) chartCourse.destroy();
  chartCourse = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg},
        {label:'Intentos', data: dataAtt}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}
function renderStudentChart(rows){
  const ctx = document.getElementById('chart-student').getContext('2d');
  const labels = rows.map(r=>`${r.courseId}-${r.oa}`);
  const dataAvg = rows.map(r=>Number(r.promedio));
  if(chartStudent) chartStudent.destroy();
  chartStudent = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}

async function loadStatsCourse(){
  const id = $('#st_course').value.trim();
  if(!id) return alert('Ingresa courseId');
  const r = await PEVE_ADMIN.peveStatsByCourse(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-course tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderCourseChart(r.rows||[]);
}

async function loadStatsStudent(){
  const id = $('#st_user').value.trim();
  if(!id) return alert('Ingresa userId');
  const r = await PEVE_ADMIN.peveStatsByStudent(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-student tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.courseId}</td><td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderStudentChart(r.rows||[]);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js">
let chartCourse, chartStudent;
function renderCourseChart(rows){
  const ctx = document.getElementById('chart-course').getContext('2d');
  const labels = rows.map(r=>r.oa);
  const dataAvg = rows.map(r=>Number(r.promedio));
  const dataAtt = rows.map(r=>Number(r.intentos));
  if(chartCourse) chartCourse.destroy();
  chartCourse = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg},
        {label:'Intentos', data: dataAtt}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}
function renderStudentChart(rows){
  const ctx = document.getElementById('chart-student').getContext('2d');
  const labels = rows.map(r=>`${r.courseId}-${r.oa}`);
  const dataAvg = rows.map(r=>Number(r.promedio));
  if(chartStudent) chartStudent.destroy();
  chartStudent = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}

async function loadStatsCourse(){
  const id = $('#st_course').value.trim();
  if(!id) return alert('Ingresa courseId');
  const r = await PEVE_ADMIN.peveStatsByCourse(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-course tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderCourseChart(r.rows||[]);
}

async function loadStatsStudent(){
  const id = $('#st_user').value.trim();
  if(!id) return alert('Ingresa userId');
  const r = await PEVE_ADMIN.peveStatsByStudent(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-student tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.courseId}</td><td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderStudentChart(r.rows||[]);
}
</script>

</head>
<body>

<header class="header">
  <div class="logo">
    <span class="badge">PEVE</span>
    <span class="title">Plataforma ExÃ¡menes de ValidaciÃ³n de Estudios</span>
  </div>
  <div class="row">
    <button class="toggle" data-action="fs-dec">Aâˆ’</button>
    <button class="toggle" data-action="fs-inc">A+</button>
    <button class="toggle" data-action="contrast">ğŸŒ“ Alto contraste</button>
  </div>
</header>

<main>
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2>ğŸ‘©â€ğŸ« Panel Docente â€” <span id="who"></span></h2>
    <button class="toggle" data-action="logout">Cerrar sesiÃ³n</button>
  </div>
  <div class="grid">
    <div class="card">
      <h3>OA BiologÃ­a 1M</h3>
      <ul id="oa"></ul>
      <div class="row">
        <a class="btn" href="../pages/quiz_bio1m.html">ğŸ§ª Gestionar Quiz</a>
        <a class="btn" href="../pages/ticket_bio1m.html">ğŸŸï¸ Ticket de salida</a>
      </div>
    </div>
    <div class="card">
      <h3>Dashboard (demo)</h3>
      <p>Vista rÃ¡pida de avance (simulada):</p>
      <table class="table">
        <tr><th>Estudiante</th><th>Quiz OA2</th><th>Quiz OA4</th><th>Quiz OA6</th><th>Quiz OA8</th></tr>
        <tr><td>Estudiante Demo</td><td>85%</td><td>70%</td><td>90%</td><td>80%</td></tr>
      </table>
      <small>Conectar a Google Sheets o una API para datos reales.</small>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>ğŸ“Š EstadÃ­sticas por curso (Sheets)</h3>
      <div class="row">
        <input id="st_course" placeholder="courseId (ej: BIO1M)">
        <button class="btn" onclick="loadStatsCourse()">Cargar</button>
        <button class="btn" onclick="exportPDF()">Exportar PDF</button>
      </div>
      <table class="table" id="stats-course"><thead><tr><th>OA</th><th>Intentos</th><th>Promedio</th></tr></thead><tbody></tbody></table>
<canvas id="chart-course" style="max-height:320px"></canvas>
    </div>
    <div class="card">
      <h3>ğŸ‘¤ EstadÃ­sticas por estudiante</h3>
      <div class="row">
        <input id="st_user" placeholder="userId (ej: est1)">
        <button class="btn" onclick="loadStatsStudent()">Cargar</button>
      </div>
      <table class="table" id="stats-student"><thead><tr><th>Curso</th><th>OA</th><th>Intentos</th><th>Promedio</th></tr></thead><tbody></tbody></table>
<canvas id="chart-student" style="max-height:320px"></canvas>
    </div>

    <div class="card">
      <h3>ğŸ“ Adjuntar evidencia (Drive)</h3>
      <p>Sube un archivo (PDF/imagen) como evidencia vinculada a un OA.</p>
      <div class="row">
        <input id="ev_user" placeholder="userId">
        <input id="ev_course" placeholder="courseId">
        <input id="ev_oa" placeholder="OA (ej: OA2)">
      </div>
      <input type="file" id="ev_file" accept="image/*,application/pdf">
      <div class="row"><button class="btn green" onclick="uploadEvidence()">Subir</button></div>
      <p id="ev_out" class="notice">â€”</p>
    </div>
  </div>
</main>
<script>
async function loadStatsCourse(){
  const id = $('#st_course').value.trim();
  if(!id) return alert('Ingresa courseId');
  const r = await PEVE_ADMIN.peveStatsByCourse(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-course tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
}

async function loadStatsStudent(){
  const id = $('#st_user').value.trim();
  if(!id) return alert('Ingresa userId');
  const r = await PEVE_ADMIN.peveStatsByStudent(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-student tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.courseId}</td><td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
}

async function exportPDF(){
  const id = $('#st_course').value.trim() || 'SIN_ID';
  const html = document.querySelector('#stats-course').outerHTML;
  const r = await PEVE_ADMIN.peveExportPDF('Reporte_'+id, html).catch(e=>alert('No se pudo exportar'));
  if(r && r.pdfUrl) window.open(r.pdfUrl, '_blank');
}

async function uploadEvidence(){
  const f = $('#ev_file').files[0];
  if(!f) return alert('Selecciona archivo');
  const meta = {
    userId: $('#ev_user').value.trim(),
    courseId: $('#ev_course').value.trim(),
    oa: $('#ev_oa').value.trim()
  };
  const arr = await f.arrayBuffer();
  const base64 = btoa(String.fromCharCode(...new Uint8Array(arr)));
  const r = await PEVE_ADMIN.peveUploadEvidence(f.name, f.type, base64, meta).catch(e=>$('#ev_out').textContent='Error');
  if(r && r.fileUrl) $('#ev_out').textContent = 'Evidencia subida: ' + r.fileUrl; else $('#ev_out').textContent='Sin URL';
}

let chartCourse, chartStudent;
function renderCourseChart(rows){
  const ctx = document.getElementById('chart-course').getContext('2d');
  const labels = rows.map(r=>r.oa);
  const dataAvg = rows.map(r=>Number(r.promedio));
  const dataAtt = rows.map(r=>Number(r.intentos));
  if(chartCourse) chartCourse.destroy();
  chartCourse = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg},
        {label:'Intentos', data: dataAtt}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}
function renderStudentChart(rows){
  const ctx = document.getElementById('chart-student').getContext('2d');
  const labels = rows.map(r=>`${r.courseId}-${r.oa}`);
  const dataAvg = rows.map(r=>Number(r.promedio));
  if(chartStudent) chartStudent.destroy();
  chartStudent = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label:'Promedio', data: dataAvg}
      ]
    },
    options: {responsive:true, maintainAspectRatio:false}
  });
}

async function loadStatsCourse(){
  const id = $('#st_course').value.trim();
  if(!id) return alert('Ingresa courseId');
  const r = await PEVE_ADMIN.peveStatsByCourse(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-course tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderCourseChart(r.rows||[]);
}

async function loadStatsStudent(){
  const id = $('#st_user').value.trim();
  if(!id) return alert('Ingresa userId');
  const r = await PEVE_ADMIN.peveStatsByStudent(id).catch(e=>alert('No se pudo cargar'));
  const tb = document.querySelector('#stats-student tbody'); tb.innerHTML='';
  (r.rows||[]).forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.courseId}</td><td>${x.oa}</td><td>${x.intentos}</td><td>${x.promedio}</td>`;
    tb.appendChild(tr);
  });
  renderStudentChart(r.rows||[]);
}
</script>



<footer class="footer">
  <div>PEVE - Plataforma ExÃ¡menes de ValidaciÃ³n de Estudios</div>
  <div>ğŸ‘©â€ğŸ« BelÃ©n AcuÃ±a PÃ©rez â€” ğŸ“§ belen.acpe@gmail.com Â· ğŸ“ +56 9 6266 4960</div>
  <div>ğŸ‘¨â€ğŸ’» Francisco Pinto â€” ğŸ“§ franciscoandresp@gmail.com Â· ğŸ“ +56 9 2002 7992</div>
  <div>Hecho con â¤ï¸ para el Liceo Bicentenario de Excelencia Polivalente San NicolÃ¡s</div>
  <div>PEVE - Todos los derechos reservados - Prohibida su reproduccion</div>
  <div>PEVE - 2025/2026</div>
</footer>
  
</body></html>
